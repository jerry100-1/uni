<template>
	<view class="content">
		<view class="top"></view>
		<view class="uni-page-head">
			<view class="l">
				<image src="../../static/logo@2x.png" alt="" class="logo"></image>
			</view>
			<view class="center">
				我的店
			</view>
			<view class="r">
				<view @tap="changeDown">
					<image src="../../static/home/addpng.png" class="add" mode="widthFix" ></image>
				</view>
				<view @tap="url" data-url="/pages/system/system">
					<image src="../../static/home/system.png" class="system" mode="widthFix"  ></image>
				</view>
				<view class="down" v-if="isDown">
					<view class="up"></view>
					<view class="border" @tap="url" data-url="/pages/wx/wxReceipt" v-if="isPayQR">
						微信收款
					</view>
					<view class="border" @tap="urlCode" data-url="/pages/wx/channel" v-if="shopObj.level*1<3">
						渠道邀请
					</view>
					<view class="border" @tap="urlCode" data-url="/pages/wx/userInvitation">
						用户邀请
					</view>
				</view>
			</view>
		</view>
		<view class="shopInfo">
			<view class="img">
				<image :src="shopObj.disPlayImg" @tap="changeImg"></image>
			</view>
			<view>
				<view>{{shopObj.shopName}}</view>
				<view>上次登录:{{shopObj.loginTime}}</view>
			</view>
			<view class="r">
				<view>
					{{shopObj.levelName}} （{{shopObj.levelName=="C"?'事业部':shopObj.levelName=="B"?'互信版':shopObj.levelName=="A2"?'互爱版':'愉悦版'}}）
				</view>
			</view>
		</view>
		<view class="proList">
			<view v-for="(item,index) in textInfo.imgs" :key="index">
				<image :src="item"></image>
			</view>
		</view>
		<view class="textInfo">
			<view>
				<view>
					<text>{{textInfo.memberCount}}</text>
					<view class="text">用户总数</view>
				</view>
				<view>
					<text>{{textInfo.orderCount}}</text>
					<view class="text">订单总数</view>
				</view>
				<view>
					<text>{{textInfo.sellAmount}}</text>
					<view class="text">销售金额</view>
				</view>
				<view>
					<text>{{textInfo.collectCount}}</text>
					<view class="text">收藏总数</view>
				</view>
			</view>
			<view>
				<view v-if="shopObj.level*1<3">
					<text>{{textInfo.a1ChannelCount}}</text>
					<view class="text">渠道A1数</view>
				</view>
				<view  v-if="shopObj.level*1<3">
					<text>{{textInfo.a2ChannelCount}}</text>
					<view class="text">渠道A2数</view>
				</view>
				<view  v-if="shopObj.level*1<2">
					<text>{{textInfo.bChannelCount}}</text>
					<view class="text">渠道B数</view>
				</view>
				<!-- <view>
					<text>{{textInfo.browseCount}}</text>
					<view class="text">浏览总数</view>
				</view> -->
			</view>
		</view>
		<view class="banner">
			<image src="/static/home/banner.png" alt="" mode="widthFix"></image>
		</view>
		<view class="enter">
			<view>
				<view @tap="url" data-url="/pages/user/userAdmin">
					<view class="enter_item bg1">
						<image src="/static/home/user.png" alt="" mode="widthFix"></image>
						<text>用户</text>
					</view>

				</view>
				<view>
					<view class="enter_item bg2" @tap="url" data-url="/pages/pro/index">
						<image src="/static/home/shop.png" alt="" mode="widthFix"></image>
						<text>商品</text>
					</view>
				</view>
				<view>
					<view class="enter_item bg3" @tap="url" data-url="/pages/order/orderList">
						<image src="/static/home/order.png" alt="" mode="widthFix"></image>
						<text>订单</text>
					</view>
				</view>
			</view>
			<view>
				<view>
					<view class="enter_item bg4" @tap="url" data-url="/pages/capital/index">
						<image src="/static/home/capt.png" alt="" mode="widthFix"></image>
						<text>资金</text>
					</view>
				</view>
				<view>
					<view class="enter_item bg5" @tap="url" data-url="/pages/enter/index">
						<image src="/static/home/invit.png" alt="" mode="widthFix"></image>
						<text>渠道</text>
					</view>
				</view>
				<view>
					<view class="enter_item bg6" @tap="url" data-url="/pages/msg/msgList">
						<image src="/static/home/msg.png" alt="" mode="widthFix"></image>
						<text>消息</text>
					</view>
				</view>
			</view>
		</view>
		<view class="msg" v-if="false">
			<view>
				<image src="/static/home/user.png" alt="" mode="widthFix"></image>
				<view>
					<view class="h5">
						乐享公告
					</view>
					<view>
						【与你有关】春节期间乐享各项工作安排
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	export default {
		data() {
			return {
				isPayQR:"",
				shopObj:{},
				textInfo: {},
				invite: "",//13327313408
				isDown: false, //是否显示微信收款等下拉
			}
		},
		methods: {
			limit(limit){
				var size = "";
				size = (limit/(1024 * 1024)).toFixed(2);//转MB
				var sizeStr = size + "";                        //转成字符串
				var index = sizeStr.indexOf(".");                    //获取小数点处的索引
				var dou = sizeStr.substr(index + 1 ,2)            //获取小数点后两位的值
				if(dou == "00"){                                //判断后两位是否为00，如果是则删除00
					return sizeStr.substring(0, index) + sizeStr.substr(index + 3, 2)
				}
				return size;
			},
			//更换店铺图片
			changeImg(){
				let that=this;
				uni.chooseImage({
					count: 1, //默认9
					sizeType: ['original', 'compressed'], //可以指定是原图还是压缩图，默认二者都有
					success: function (res) {
						if(that.limit(res.tempFiles[0].size)>3){
							uni.showToast({
								title:"图片太大",
								icon:"none"
							})
							return
						}
				        that.$ajax({
							uploadFile:true,
							formData:{
								'fileName':"/marchant/",
							},
							filePath:res.tempFilePaths[0],
							success(d){
								that.uploadImg(d)
								that.shopObj.disPlayImg=d;
								uni.setStorage({
									key:"shopObj",
									data:JSON.stringify(that.shopObj)
								})
							}
						})
						
				
					},
				});
			},
			uploadImg(src){
				let that=this;
				that.$ajax({
					url:"/system_manager/setLogo",
					data:{
						displayImg: src,
						shopId:that.shopObj.shopId
					},success(d){
						console.log(d);
					}
				})
			},
			urlCode(e){
				let type=parseInt(Math.random()*2,10);
				uni.navigateTo({
					url: e.currentTarget.dataset.url+"?type="+type
				})
			},
			url(e) {
				uni.navigateTo({
					url: e.currentTarget.dataset.url
				})
			},
			changeDown(e) {
				this.isDown = !this.isDown
			},
			isExistsOfflinePayQR(){
				let that=this;
				that.$ajax({
					url:"/merchant/isExistsOfflinePayQR",
					data:{
						merchantId:that.shopObj.merchantId
					},
					success(d){
						that.isPayQR=d;
					}
				})
			}
		},
		onShow() {
			let that=this;	
			that.isDown = false;
			that.$ajax({
				url:"/token/get",
				method:"POST",
				data:{
					merchantId:that.shopObj.merchantId
				},success(d){
					uni.setStorage({
						key:"Token",
						data:d
					})
					that.$ajax({
						url:"/home/index",
						data:{
							level: that.shopObj.level,
							merchantId: that.shopObj.merchantId,
							shopId: that.shopObj.shopId
						},success(d){		
							that.textInfo=d;
							that.isExistsOfflinePayQR()
						}
					})
				}
			})
		},
		onLoad() {
			let that=this;
			uni.getStorage({
				key:"shopObj",
				success(res){
					console.log(res)
					that.shopObj=JSON.parse(res.data);
					console.log(that.shopObj)
					if (!that.shopObj.shopId) {
						uni.showModal({
							title: '未登录',
							content: '登录失效，需要登录后才能继续',
							/**
							 * 如果需要强制登录，不显示取消按钮
							 */
							showCancel: !that.forcedLogin,
							success: (res) => {
								if (res.confirm) {
									// /**
									//  * 如果需要强制登录，使用reLaunch方式
									//  */
									if (that.forcedLogin) {
										uni.reLaunch({
											url: '../login/login'
										});
									} else {
										uni.reLaunch({
											url: '../login/login'
										});
									}
								}
							}
						});
					}
				}
			})
		}
	}
</script>

<style scoped>
	* {
		box-sizing: border-box;
	}

	.content {
		padding: 0;
		background: #f2f2f2;
	}

	.img image{
		width:160upx;
		height:160upx;
	}
	.content>view {
		background: #fff;
	}

	.add {
		width: 30upx;
		height: 30upx;
	}

	.system {
		width: 35upx;
		height: 35upx;
	}

	.content .uni-page-head {
		box-sizing: border-box;
		height: 128upx;
		background: rgb(15, 174, 255);
		width: 100%;
		position: fixed;
		top: 0;
		left: 0;
		text-align: center;
		padding: 40upx 30upx 0;
		z-index: 10000;
		color: #fff;
	}

	.uni-page-head .r {
		margin-top: 30upx;
	}
	.uni-page-head .r>view{
		display: inline-block;
		width: 60upx;
	}
	.uni-page-head .r .down {
		background: #fff;
		color: #333;
		position: absolute;
		width: 200upx;
		right: 20upx;
		top: 130upx;
		border-radius: 10upx;
		-webkit-box-shadow: 2upx 2upx #eee;
		box-shadow: 4upx 8upx #eee;
	}

	.uni-page-head .down>view {
		line-height: 80upx;

	}

	.uni-page-head .down .border {
		border-bottom: 1px solid #eee;
	}

	.uni-page-head .up {
		display: block;
		width: 0;
		height: 0;
		border-width: 0px 12upx 16upx;
		border-style: solid;
		border-color: transparent transparent #fff;
		position: absolute;
		top: -16upx;
		left: 100upx;
	}

	.uni-page-head>view {
		display: inline-block;
	}

	.uni-page-head .logo {
		width: 52upx;
		margin-top: 14upx;
		height: 52upx;
	}

	.uni-page-head .center {
		line-height: 88upx;
	}

	.shopInfo {
		margin-top: 128upx;
		padding: 10upx 30upx;
		padding-top: 16upx;
		border-bottom: 1px solid #eee;
	}

	.shopInfo>view {
		display: inline-block;
		vertical-align: top;
		font-size: 28upx;
	}

	.shopInfo image {
		width: 80upx;
		height: 80upx !important;
		margin-right: 20upx;
	}

	.shopInfo .r {
		color: #ee3535;
	}

	.proList {
		padding: 20upx 30upx;
		display: flex;
	}

	.proList>view {
		flex: 1;
		height: 160upx;
		margin-right: 10upx;
	}

	.proList>view image {
		width: 160upx;
		height:160upx;
	}

	.textInfo>view {
		padding: 10upx 30upx;
	}

	.textInfo>view>view {
		width:160upx;
		display: inline-block;
		margin-right: 10upx;
		text-align: center;
	}

	.textInfo .text {
		font-weight: 500;
		color: #333;
		font-size: 26upx;
		margin-top: 20upx;
	}

	.content .banner {
		background: #e2e2e2;
		padding: 20upx 0;
	}

	.banner image {
		width: 100%;
	}

	.enter {
		padding-bottom: 60upx;
	}

	.enter>view {
		display: flex;
	}

	.enter>view>view {
		flex: 1;
		text-align: center;
	}

	.enter .enter_item {
		height: 160upx;
		width: 160upx;
		margin: 36upx auto 0;
		border-radius: 10upx;
		text-align: center;
	}

	.enter .enter_item image {
		width: 60upx;
		height: 60upx !important;
		margin-top: 20upx;
	}

	.enter .enter_item text {
		display: block;
		color: #fff;
	}

	.bg1 {
		background: #2ED3B2;
	}

	.bg2 {
		background: #4A9AEE;
	}

	.bg3 {
		background: #E65555;
	}

	.bg4 {
		background: #FFA318;
	}

	.bg5 {
		background: #C458E7;
	}

	.bg6 {
		background: #4ECD72;
	}

	.content .msg {
		height: 136upx;
		padding-top: 36upx;
		background: #E2E2E2;
	}

	.msg>view {
		height: 100upx;
		background: #fff;
		padding: 0 30upx;

	}

	.msg image {
		width: 72upx;
		height: 72upx;
		margin-top: 14upx;
		margin-right: 22upx;
		background: red;
		vertical-align: middle;
	}

	.msg>view>view {
		display: inline-block;
		font-size: 24upx;
		vertical-align: middle;
	}

	.msg .h5 {
		font-size: 28upx;
	}
</style>
