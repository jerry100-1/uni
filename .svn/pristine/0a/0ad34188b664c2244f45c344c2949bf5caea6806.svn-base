<template>
	<view class="content">
		<view class="shopInfo">
			<view>
				<text>商品名称</text>
				<input type="text" v-model="shopName" placeholder="商品名称长度至少3个字符，最长50个汉字" maxlength="50"/>
			</view>
			<view>
				<text>商品简介</text>
				<textarea v-model="shopIntr" placeholder="商品简介最多50个汉字（选填）" maxlength="50"/>
			</view>
		</view>
		<view class="step2">
			<view>
				<text>商品分类</text>
		
				<picker  :range="shopClassify"  @change="shopClassifyChange" >
					<view class="ellipsis">
							<text class="yticon icon-xia caIco"></text> 
						<view class="uni-icon-arrowdown" style="color:red;font-size:30upx;"></view>
						
					{{shopClassify[shopIndex]||"分类"}}
					   <!-- <text class=""></text> -->
					  
					   
					</view>
					
					<!-- <uni-icon type="arrowdown" size="18" color="#999"></uni-icon> -->
				</picker>
				
				<picker  :range="twoCate" @change="twoCateFun" range-key="catename">
					<view class="ellipsis">{{twoCate[twoIndex].catename||"分类"}}</view>
					<!-- <uni-icon type="arrowdown" size="18" color="#999"></uni-icon> -->
				</picker>
				<picker  :range="threeCate" @change="threeCateFun" range-key="catename">
					<view class="ellipsis">{{threeCate[threeIndex].catename||"分类"}}</view>
					<!-- <uni-icon type="arrowdown" size="18" color="#999"></uni-icon> -->
				</picker>
			</view>
			<view>
				<text>商品品牌</text>
				<picker  :range="shopBrand" @change="shopBrandChange" range-key="brandname">
					<view class="ellipsis">{{shopBrand[shopBrandIndex].brandname||"分类"}}</view>
				<!-- 	<uni-icon type="arrowdown" size="18" color="#999"></uni-icon> -->
				</picker>
			</view>
			<view>
				<text>商品产地</text>
				<picker  :range="provinceList" @change="provinceListChange" range-key="proName">
					<view class="ellipsis">{{provinceList[provinceIndex].proName||"请选择"}}</view>
					<!-- <uni-icon type="arrowdown" size="18" color="#999"></uni-icon> -->
				</picker>
				<picker  :range="cityList" @change="cityListChange" range-key="proName">
					<view class="ellipsis">{{cityList[cityIndex].proName||"请选择"}}</view>
					<!-- <uni-icon type="arrowdown" size="18" color="#999"></uni-icon> -->
				</picker>
			</view>
		</view>
		
		<view class="step3">
			<view>
				<text>商品售价</text>
				<input type="number" v-model="price" />
				<text>元</text>
			</view>
			<view>
				<text>市场售价</text>
				<input type="number" v-model="shopPrice" />
				<text>元</text>
			</view>
			<view>
				<text>联盟经费</text>
				<view class="inline">
					<view class="btn" :class="{active:productRatio==0}" @tap="proRatio(0)">8%</view>
					<view class="btn" :class="{active:productRatio==1}" @tap="proRatio(1)">15%</view>
					<view>该商品交易成功后,平台按比例奖励用户时光豆;8%,奖励交易金额的30%;15%,奖励交易金额的100%;</view>
				</view>
			</view>
			<view>
				<text>商品图片</text>
				<view class="right">
					<view class="imgs" v-for="(item,index) in proImgs" v-if="proImgs.length>0" :key="index">
						<image :src="item"></image>
						<view @tap="del(index,1)" class="del">删除</view>
					</view>
					<image src="../../static/capital/my_add_image@2x.png" @tap="proImgsChoose(1)" v-if="proImgs.length!=5" ></image>
				</view>
				
				<view class="textInfo">
					<text>上传商品图片,图片支持jpg,gif,png格式,最多只能上传5张,</text>
					<text class="color">建议使用尺寸800x800像素以上,大小不超过1M的正方形图片;</text>
				</view>
			</view>
		</view>
		<view class="step4">
			<view>
				<text>商品重量</text>
				<input type="number" v-model="proWeight" />
				<text>克</text>
			</view>
			<view>
				<text>是否包邮</text>
				<checkbox-group class="inlines" @change="expressFun">
                    <label>
                        <checkbox value="1" :checked="expressConfig==1" color="#EE3535"/>是
                    </label>
				</checkbox-group>
				<text>非包邮商品,请到管理后台上传</text>
			</view>
			<view>
				<text class="left">商品库存</text>
				<input type="number" v-model="skoce" class="input"/>
			</view>
			<view>
				<text class="left">关键词</text>
				<input type="text" v-model="keyWord" class="input"/>
			</view>
			<view>
				<text>商品详情</text>
				<view class="inlines">
				<!-- 	<textarea v-model="shopDetails" placeholder="商品详情文字说明" /> -->
					<view class="right">
						<view class="imgs" v-for="(item,index) in proDetailsImg" v-if="proDetailsImg.length>0" :key="index">
							<image :src="item" mode="widthFix"></image>
							<view @tap="del(index,2)" class="del">删除</view>
						</view>
						<image src="../../static/capital/my_add_image@2x.png" @tap="proImgsChoose(2)" class="up"></image>
					</view>
					<view>
						<text>温馨提示:编辑商品建议去管理后台,商品详情请上传图片,图片支持jpg,gif,png格式,</text>
						<text class="color">大小不超过1M;</text>
					</view>
				</view>
				
			</view>
		</view>
		<button @tap="save">保存</button>
	</view>
</template>

<script>
	import uniIcon from "@/components/uni-icon/uni-icon.vue"
	import { pathToBase64, base64ToPath } from '@/js_sdk/gsq-image-tools/image-tools/index.js'
	export default{
		components: {
			uniIcon
		},
		data(){
			return{
				isreq:false,
				shopObj:{},
				initNum:[0,0,0],//是否第一次选(分类，品牌，城市)
				cateId2:"",//编辑时二级分类
				cateId3:"",
				brandId:"",
				produceCity:"",
				produceProvince:"",
				proId:"",//商品id
				shopName:"",//商品名
				shopIntr:"",//商品简介
				shopPrice:"",//商品市场价
				price:"",//商品价格
				skoce:"",//商品库存
				proWeight:0,//商品重量
				expressConfig:1,//是否包邮1包邮2不包邮3邮费到付
				keyWord:"",//关键词
				proImgs:[],//商品图片
				shopDetails:"",//商品详情
				proDetailsImg:[],//商品详情图片
				shopBrand:[{brandname:""}],//商品品牌
				shopBrandIndex:0,//
				shopClassify:["联盟商家"],//商品分类
				shopIndex:0,//商品分类选中下标
				twoCate:[{catename:""}],//商品二级分类
				twoIndex:0,
				productRatio:0,//联盟经费0为8%,1为15%
				threeCate:[{catename:""}],//商品三级分类
				threeIndex:0,
				provinceList:[{proName:""}],//省
				provinceIndex:0,//
				cityList:[{proName:""}],//市
				cityIndex:0,//
			}
		},
		methods:{
			limit(limit){
				var size = "";
				size = (limit/(1024 * 1024)).toFixed(2);//转MB
				var sizeStr = size + "";                        //转成字符串
				var index = sizeStr.indexOf(".");                    //获取小数点处的索引
				var dou = sizeStr.substr(index + 1 ,2)            //获取小数点后两位的值
				if(dou == "00"){                                //判断后两位是否为00，如果是则删除00
					return sizeStr.substring(0, index) + sizeStr.substr(index + 3, 2)
				}
				return size;
			},
			//省
			provinceListChange(e){
				this.provinceIndex=e.detail.value;
				this.citySearch();
			},
			//市
			cityListChange(e){
				this.cityIndex=e.detail.value
			},
			//联盟经费的改变
			proRatio(index){
				this.productRatio=index
			},
			//查询市
			citySearch(){
				let that=this;
				that.$ajax({
					url:"/shopProduct/getCommonAddressCityList",
					method:"POST",
					data:{
						proCode:that.provinceList[that.provinceIndex].code
					},
					success(d){
						that.cityList=d;
						if(that.initNum[2]==0){
							that.initNum[2]=1
							for(let i in d){
								if(that.produceCity==d[i].code){
									that.cityIndex=i;
									break;
								}
							}
						}
					}
				})
			},
			getBytesLength (str) {
			  var num = str.length; //先用num保存一下字符串的长度（可以理解为：先假设每个字符都只占用一个字节）
			  for (var i = 0; i < str.length; i ++) { //遍历字符串
				if (str.charCodeAt(i) > 255) { //判断某个字符是否占用两个字节，如果是，num再+1
				  num ++;
				}
			  }
			  return num; //返回最终的num，既是字符串总的字节长度
			},
			//商品图片选择
			proImgsChoose(type){
				let that=this;
				
				if(type==1&&that.proImgs.length>4){
					uni.showToast({
					    title:"商品图片最多上传五张",
						icon:"none"
					});
					return
				}
				
				uni.chooseImage({
					count: 1, //默认9
					sizeType: ['original', 'compressed'], //可以指定是原图还是压缩图，默认二者都有
					success: function (res) {
						if(that.limit(res.tempFiles[0].size)>3){
							uni.showToast({
								title:"图片太大",
								icon:"none"
							})
							return
						}
                        that.$ajax({
							uploadFile:true,
							formData:{
								'fileName':"/product/",
							},
							filePath:res.tempFilePaths[0],
							success(d){
								if(type==1){
									//商品图片
									that.proImgs.push(d);
								}else{
									//商品详情图
									that.proDetailsImg.push(d)
								}
							}
						})
						

					},
				});
			},
			//商品图片上传
			uploadImg(base64,type){
				let that=this;
				uni.showLoading({
					title: '加载中'
				});
				that.$ajax({
					url:"/commonUpload/upload",
					method:"POST",
					data:{
						// base64Img:base64,
						file:base64,
						fileName:"/product/",
						//artworkMaster:0
					},success(d){
						console.log(d);
						uni.hideLoading();
						
					}
				})
			},
			//图片的删除
			del(index,type){
				let that=this;
				console.log(index)
				if(type==1){
					//商品图片
					 that.proImgs.splice(index, 1);
				}else{
					
					//商品详情图
					that.proDetailsImg.splice(index, 1);
				}
			},
			//邮费
			expressFun(e){
				this.expressConfig=e.detail.value.length==1?1:2
			},
			//商品一级分类
			shopClassifyChange(e){
				this.shopIndex=e.detail.value
			},
			//商品三级查询
			selectThree(cid){
				let that=this;
				that.$ajax({
					url:"/shopProduct/getByThreeCate",
					method:"POST",
					data:{
						cateSource: 5,
						cid: cid
					},
					success(d){
						that.threeCate=d;
						if(that.initNum[0]==0){
							that.initNum[0]=1
							for(let i in that.threeCate){
								if(that.cateId2==that.threeCate[i].cateid){
									that.threeIndex=i;
									break;
								}
							}
						}
					}
				})
			},
			//商品二级分类
			twoCateFun(e){
				let that=this;
				that.twoIndex=e.detail.value;
				that.selectThree(that.twoCate[that.twoIndex].cid)
			},
			//商品三级分类
			threeCateFun(e){
				this.threeIndex=e.detail.value
			},
			//初始化
			init(){
				let that=this;
				that.$ajax({
					url:"/shopProduct/getSelectShopProductBrand",
					method:"POST",
					success(d){
						that.shopBrand=d;
						if(that.initNum[1]==0){
							that.initNum[1]=1;
							for(let i in d){
								if(that.brandId==d[i].brandid){
									that.shopBrandIndex=i;
									break;
								}
							}
						}
						
					}
				})
				//查询二级分类
				that.$ajax({
					url:"/shopProduct/getByTwoCate",
					method:"POST",
					data:{
						cateId:3
					},
					success(d){
						that.twoCate=d;
						if(that.initNum[0]==0){
							for(let i in that.twoCate){
								if(that.cateId2==that.twoCate[i].cateid){
									that.twoIndex=i;
									break;
								}
							}
						}
						that.selectThree(that.twoCate[that.twoIndex].cid)
					}
				})
				//查询省
				that.$ajax({
					url:"/shopProduct/getCommonAddressProvinceList",
					method:"POST",
					success(d){
						that.provinceList=d;
						if(that.initNum[2]==0){
							for(let i in d){
								if(that.produceProvince==d[i].code){
									that.provinceIndex=i;
									break;
								}
							}
						}
						that.citySearch()
					}
				})
				
			},
			//保存
			save(){
				let that=this;
				console.log(0)
				if(!that.shopName||!that.price||!that.shopPrice||that.proImgs.length==0||!that.skoce||that.proDetailsImg.length==0){
					uni.showToast({
						title:"请填写完整的信息",
						icon:"none"
					})
					return
				}
				if(that.isreq){
					return
				}
				that.isreq=true
				that.$ajax({
					url:"/shopProduct/saveShopProduct",
					method:"POST",
					data:{
						brandId: that.shopBrand[that.shopBrandIndex].brandid,
						cateId1: 3,
						cateId2: that.twoCate[that.twoIndex].cateid,
						cateId3: that.threeCate[that.threeIndex].cateid,
						expressConfig: that.expressConfig,
						keyWord: that.keyWord,
						originalImg: that.proImgs,
						produceCity: that.cityList[that.cityIndex].code,
						produceProvince: that.provinceList[that.provinceIndex].code,
						productDescribeImg: that.proDetailsImg,
						productId: that.proId||"",
						productName: that.shopName||"",
						productRatio: that.productRatio==0?8:15,
						productTitle: that.shopIntr,
						productmMinMoney: that.price*1,
						shopId: that.shopObj.shopId,
						sumStock: that.skoce*1,
						weight: that.proWeight,
						agoraMoney:that.shopPrice
					},
					success(d){
						that.isreq=false;
						uni.showToast({
							title:"操作成功",
							icon:"none"
						})
						setTimeout(function() {
							uni.navigateBack({
								delta: 1
							});
						}, 1500);
						
					},
					error(){
						that.isreq=false;
					}
				})
			}
		},
		onLoad(e){
			let that=this;
			uni.getStorage({
				key:"shopObj",
				success(res){
					that.shopObj=JSON.parse(res.data);
				}
			})
			if(e.proId){
				this.proId=e.proId;
				uni.setNavigationBarTitle({
					title: '商品编辑'
				});
				this.$ajax({
					url:"/shopProduct/getUpdateProduct",
					method:"POST",
					data:{
						productId:that.proId
					},
					success(d){
						console.log(d)
						that.proImgs=d.originalImg;
						that.shopName=d.productName||"";
						that.skoce=d.sumStock||"";
						that.shopIntr=d.productTitle||"";
						that.keyWord=d.keyWord||"";
						that.price=d.productmMinMoney||"";
						that.productRatio=d.productRatio==15?1:0;
						that.expressConfig=d.expressConfig;
						that.proWeight=d.weight;
						that.cateId2=d.cateId2;
						that.cateId3=d.cateId3;
						that.brandId=d.brandId;
						that.shopPrice=d.agoraMoney||"";
						that.produceCity=d.produceCity;
						that.produceProvince=d.produceProvince;
						var imgReg = /<img.*?(?:>|\/>)/gi;
						var srcReg = /src=[\'\"]?([^\'\"]*)[\'\"]?/i;
						var arr = [];
						if(d.productDescribe){
							arr=d.productDescribe.match(imgReg)
						}
						console.log(arr)
						that.$ajax({
							url:"/shopProduct/getByTwoCate",
							method:"POST",
							data:{
								cateId:3
							},
							success(d){
								that.twoCate=d;
								if(that.initNum[0]==0){
									for(let i in that.twoCate){
										if(that.cateId2==that.twoCate[i].cateid){
											that.twoIndex=i;
											break;
										}
									}
								}
								that.selectThree(that.twoCate[that.twoIndex].cid)
							}
						})
						for (var i = 0; i < arr.length; i++) {
							var src = arr[i].match(srcReg);
							console.log(src,"111")
							 //获取图片地址
							that.proDetailsImg.push(src[1])
						}
						that.init()
					}
				})				
			}else{
				that.initNum=[1,1,1];
				that.init()
			}
		}
	}
</script>

<style scoped>
	.content{
		background: #f2f2f2;
		padding: 0;
	}
	.content>view{
		padding: 30upx;
		background: #fff;
		font-size: 26upx;
		margin-bottom: 20upx;
	}
	.step2>view{
		margin-bottom: 20upx;
		font-size: 26upx;
	}
	.step2 picker{
		width:160upx;
		
	}
	.uni-icon{
		margin-top: -40upx;
	}
	.ellipsis{
		line-height:60upx;
		width:120upx;
		display: inline-block;
		text-overflow: ellipsis;
		overflow: hidden;
		white-space: nowrap;
	}
	picker{
		display: inline-block;
		width: 500upx;
		margin-left: 20upx;
		vertical-align: middle;
		border:1px solid #eee;
		padding-left: 10upx;
		border-radius: 20upx;
	}
	.shopInfo>view{
		margin-bottom: 20upx;
	}
	.shopInfo input{
		display: inline-block;
		width:550upx;
		border-bottom: 1px solid #eee;
		vertical-align: middle;
		margin-left: 20upx;
		font-size: 24upx;
	}
	textarea{
		display: inline-block;
		width:550upx;
		height:160upx;
		font-size: 26upx;
		margin-left: 20upx;
		vertical-align: text-top;
		border-bottom:1px solid #eee;
	}
	button{
		width:525upx;
		height:72upx;
		text-align: center;
		background: #EE3535;
		line-height: 72upx;
		color:#fff;
		margin: 35upx auto 50upx;
		border-radius: 20upx;
		font-size: 28upx;
	}
	.step3>view{
		margin-bottom: 10upx;
	}
	.inline{
		display: inline-block;
		width: 560upx;
		font-size: 22upx;
		vertical-align: text-top;
		margin-left: 10px;
		color:#999;
	}
	.step3 .btn{
		display: inline-block;
		width:105upx;
		height: 48upx;
		line-height: 48upx;
		border-radius: 10upx;
		background: #f3f3f3;
		color:#666;
		margin-bottom: 20upx;
		text-align: center;
		margin-right: 20upx;
	} 
	.right{
		display: inline-block;
		width: 520upx;
		vertical-align: text-top;
	}
	.step3 .btn.active{
		background: #EE3535;
		color:#fff;
	}
	.step3 input,.step4 input{
		width:160upx;
		margin: 0 20upx;
		vertical-align: middle;                                                                                                             
		display: inline-block;
		border-bottom: 1px solid #eee;
	}
	
	.color{
		color:#EE3535;
	}
	.step3 .textInfo{
		margin-top: 20upx;
		margin-left: 120upx;
		color:#999;
		font-size: 18upx;
	}
	.step3 image,.step4 image{
		margin-left: 20upx;
		display: inline-block;
		width:110upx;
		vertical-align: top;
	}
	.step3 image{
		height:110upx;
	}
	.step4 image{
		width:520upx;
	}
	.step4 .up{
		width:110upx;
		height:110upx;
	}
	.step4>view{
		margin-bottom: 20upx;
	}
	.step4 .inline{
		color:#333;
		vertical-align: inherit;
	}
	.left{
		display: inline-block;
		width: 106upx;
	}
	.step4 .input{
		width:520upx
	}
	.step4 .inlines{
		display: inline-block;
		margin-right: 20upx;
		margin-left: 20upx;
		font-size: 18upx;
		color:#999;
		vertical-align:middle;
	}
	.step4 .inlines textarea{
		margin-bottom: 20upx;
	}
	.imgs{
		display: inline-block;
		vertical-align: middle;
		margin-bottom: 20upx;
	}
	.del{
		font-size: 20upx;
		line-height: 36upx;
		text-align: center;;
		background: #ddd;
		width:116upx;
		margin-left: 20upx;
		margin-top: 10upx;
	}
</style>
